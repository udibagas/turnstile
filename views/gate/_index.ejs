<h1 class="my-5">Gate</h1>

<button type="button" class="btn btn-primary mb-5" id="btn-add">
  Tambah Gate
</button>

<table class="table">
  <thead>
    <tr>
      <th>No.</th>
      <th>Nama</th>
      <th>Host</th>
      <th>Port</th>
      <th class="text-center" style="width: 200px">Action</th>
    </tr>
  </thead>
  <tbody>
    <% gates.forEach(({id, name, host, port,}, index) => { %>
    <tr>
      <td><%= index + 1 %></td>
      <td><%= name %></td>
      <td><%= host %></td>
      <td><%= port %></td>
      <td class="text-center">
        <a class="btn btn-primary btn-sm" href="/gate/log/<%= id %>">Log</a>
        <a
          class="btn btn-info btn-sm btn-edit"
          data-id="<%= id %>"
          data-name="<%= name %>"
          data-host="<%= host %>"
          data-port="<%= port  %>"
          href="#"
          >Edit</a
        >
        <a class="btn btn-danger btn-sm btn-delete" data-id="<%= id %>" href="#"
          >Hapus</a
        >
      </td>
    </tr>
    <% }) %>
  </tbody>
</table>

<%- include('_form') %>

<script>
  const inputElement = {};
  inputElement.name = document.querySelector("#name");
  inputElement.host = document.querySelector("#host");
  inputElement.port = document.querySelector("#port");

  const modal = new bootstrap.Modal("#formModal");
  const formTitle = document.querySelector("#formModalLabel");
  const addBtn = document.querySelector("#btn-add");

  function openForm(data) {
    const { id = "", name = "", host = "", port = "" } = data;
    formTitle.innerText = id ? "Edit Gate" : "Tambah Gate";
    inputElement.name.value = name;
    inputElement.host.value = host;
    inputElement.port.value = port;
    modal.show();
  }

  addBtn.addEventListener("click", (e) => {
    e.preventDefault();
    openForm({});
  });

  document.querySelectorAll(".btn-edit").forEach((el) => {
    el.addEventListener("click", (e) => {
      e.preventDefault();
      openForm(el.dataset);
    });
  });

  document.querySelectorAll(".btn-delete").forEach((el) => {
    el.addEventListener("click", (e) => {
      e.preventDefault();
      const id = el.dataset.id;
      if (confirm("Anda yakin akan menghapus gate ini?")) {
        window.location.href = el.href;
      }
    });
  });

  const form = document.querySelector("#gate-form");

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const { name, host, port } = inputElement;
    fetch("/gate", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify({
        name: name.value,
        host: host.value,
        port: port.value,
      }),
    })
      .then(async (res) => {
        if (!res.ok) throw res;
        const { message, data } = await res.json();
        // TODO: refresh table
        location.href = `/`;
      })
      .catch(async (res) => {
        console.log(res);
        if (res.status == 400) {
          const { errors } = await res.json();
          console.log(errors);
          form.classList.add("was-validated");
          const validation = {};
          validation.name = document.querySelector("#name-validation");
          validation.host = document.querySelector("#host-validation");
          validation.port = document.querySelector("#port-validation");

          for (let k in validation) {
            if (errors[k]) {
              inputElement[k].classList.add("is-invalid");
              validation[k].innerText = errors[k].join(", ");
            } else {
              inputElement[k].classList.add("is-valid");
              validation[k].innerText = "";
            }
          }
        }
      });
  });
</script>
